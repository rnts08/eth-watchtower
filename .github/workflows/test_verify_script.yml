name: Test Verification Script

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "verify_release.sh"
      - ".github/workflows/test_verify_script.yml"
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "verify_release.sh"
      - ".github/workflows/test_verify_script.yml"

jobs:
  test-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Dummy GPG Key
        run: |
          # Generate a key configuration file for batch generation
          cat > key-config <<EOF
          %echo Generating a basic OpenPGP key
          Key-Type: RSA
          Key-Length: 2048
          Name-Real: Test User
          Name-Email: test@example.com
          Expire-Date: 0
          %no-protection
          %commit
          %echo done
          EOF
          
          # Generate the key
          gpg --batch --generate-key key-config

      - name: Create Dummy Artifacts
        run: |
          echo "This is a test artifact" > test-artifact-1.bin
          echo "This is another test artifact" > test-artifact-2.bin

      - name: Generate Checksums
        run: sha256sum test-artifact-1.bin test-artifact-2.bin > checksums.txt

      - name: Sign Checksums
        run: gpg --batch --yes --detach-sign --armor --output checksums.txt.asc checksums.txt

      - name: Run Verification Script
        run: |
          chmod +x verify_release.sh
          echo "Testing full verification..."
          ./verify_release.sh

          echo "Testing specific file verification..."
          ./verify_release.sh test-artifact-1.bin

          echo "Testing non-existent file verification (should fail)..."
          if ./verify_release.sh non-existent-file.bin; then
            echo "Error: Verification succeeded for non-existent file"
            exit 1
          else
            echo "Success: Verification failed as expected for non-existent file"
          fi

      - name: Test Missing File in Checksums
        run: |
          # Add a file to checksums that doesn't exist on disk
          echo "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855  ghost-artifact.bin" >> checksums.txt
          
          # Re-sign checksums.txt because we modified it
          rm checksums.txt.asc
          gpg --batch --yes --detach-sign --armor --output checksums.txt.asc checksums.txt

          echo "Testing full verification (should ignore missing file)..."
          ./verify_release.sh

          echo "Testing targeted verification of missing file (should fail)..."
          if ./verify_release.sh ghost-artifact.bin; then
            echo "Error: Verification succeeded for ghost file"
            exit 1
          else
            echo "Success: Verification failed as expected for ghost file"
          fi

      - name: Test Custom Checksums File
        run: |
          # Create a custom checksums file
          cp checksums.txt custom_checksums.txt
          gpg --batch --yes --detach-sign --armor --output custom_checksums.txt.asc custom_checksums.txt

          echo "Testing verification with custom checksums file..."
          ./verify_release.sh -c custom_checksums.txt